<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktive Verordnung für Lernende</title>
    <!-- Tailwind CSS CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a polished look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chat-message {
            max-width: 80%;
            margin-bottom: 10px;
            padding: 12px 16px;
            border-radius: 20px;
        }
        .user-message {
            background-color: #3b82f6; /* Blue for user */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }
        .bot-message {
            background-color: #e5e7eb; /* Light gray for bot */
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .scrollable-content {
            overflow-y: auto;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .scrollable-content::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .message-container {
            position: relative;
        }
        .ref-link {
            position: absolute;
            bottom: 5px;
            right: 15px;
            font-size: 0.7rem;
            color: #6b7280;
        }
    </style>
</head>
<body class="flex flex-col h-screen p-4">

    <!-- Header Section -->
    <header class="bg-white shadow-md rounded-t-xl p-4 md:p-6 mb-4">
        <h1 class="text-xl md:text-2xl font-bold text-center text-gray-800">
            Interaktiver Verordnungs-Assistent
        </h1>
        <p class="text-center text-gray-500 mt-2">Stellen Sie dem Bot Fragen zur Verordnung über die berufliche Grundbildung Polymechaniker/in.</p>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow flex flex-col items-center justify-center gap-4 overflow-hidden">
        
        <!-- Chatbot Section -->
        <div class="w-full md:w-3/4 flex flex-col bg-white rounded-xl shadow-md overflow-hidden h-full">
            <h2 class="text-lg md:text-xl font-semibold p-4 text-center text-gray-700 bg-gray-100">Chatbot</h2>
            <div id="chat-messages" class="scrollable-content flex-grow p-4 flex flex-col space-y-4">
                <div class="chat-message bot-message self-start">
                    Hallo! Ich bin Ihr persönlicher Assistent für die Verordnung über die berufliche Grundbildung Polymechaniker/in EFZ. Stellen Sie mir eine Frage zum Inhalt.
                </div>
            </div>
            
            <!-- Input and Send Button -->
            <div class="p-4 bg-gray-100 border-t border-gray-200 flex items-center gap-2">
                <input type="text" id="user-input" placeholder="Stellen Sie hier Ihre Frage..." class="flex-grow p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="send-button" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0">
                    Senden
                </button>
            </div>
        </div>
    </main>

    <script type="module">
        // This is a self-contained script for the HTML page.
        // It handles UI interactions and API calls to the Gemini model.

        // --- Global variables and DOM elements ---
        const userForm = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const chatMessages = document.getElementById('chat-messages');

        let verordnungstext = '';

        // API Key is automatically provided by the Canvas environment.
        const apiKey = "";
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + apiKey;

        // Function to add a message to the chat display, now with simple markdown support
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
            messageDiv.classList.add(sender === 'user' ? 'self-end' : 'self-start');
            
            // Simple markdown for bold text: **text** -> <b>text</b>
            const processedText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            messageDiv.innerHTML = processedText;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to the bottom
        }

        // Function to extract text content from the XML file
        function extractTextFromXML(xmlDoc) {
            let text = '';
            const preamble = xmlDoc.querySelector('preamble');
            if (preamble) {
                text += preamble.textContent.trim().replace(/\s+/g, ' ') + '\n\n';
            }
            xmlDoc.querySelectorAll('article').forEach(article => {
                const num = article.querySelector('num')?.textContent.trim() || '';
                const heading = article.querySelector('heading')?.textContent.trim() || '';
                text += `${num} ${heading}\n`;
                article.querySelectorAll('paragraph').forEach(paragraph => {
                    const paraNum = paragraph.querySelector('num')?.textContent.trim() || '';
                    const content = paragraph.querySelector('content')?.textContent.trim() || '';
                    text += `${paraNum} ${content}\n`;
                });
                text += '\n';
            });
            return text;
        }

        // Function to load the XML file and start the application
        async function loadVerordnungFromRepo() {
            // Updated file path to correctly point to the 'verordnungen' subdirectory
            const filePath = './verordnungen/SR-412.101.220.88-01042024-DE.xml';
            
            try {
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`Konnte die Datei nicht laden: ${response.status}`);
                }
                const xmlText = await response.text();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                verordnungstext = extractTextFromXML(xmlDoc);
                
                addMessage('Die Verordnung wurde erfolgreich geladen. Sie können jetzt Fragen stellen.', 'bot');
                userForm.disabled = false;
                sendButton.disabled = false;
                userForm.placeholder = 'Stellen Sie hier Ihre Frage zur Verordnung...';
            } catch (error) {
                console.error('Ladefehler:', error);
                addMessage(`Ein Fehler ist aufgetreten: ${error.message}. Der Chatbot ist deaktiviert.`, 'bot');
                userForm.disabled = true;
                sendButton.disabled = true;
            }
        }
        
        // Initial call to load the XML file
        window.onload = loadVerordnungFromRepo;

        // Function to handle sending a message
        async function sendMessage() {
            const userText = userForm.value.trim();
            if (userText === '' || verordnungstext === '') return;

            addMessage(userText, 'user');
            userForm.value = '';
            sendButton.disabled = true;
            userForm.disabled = true;

            const loadingIndicator = document.createElement('div');
            loadingIndicator.classList.add('loader');
            loadingIndicator.classList.add('self-start', 'my-2', 'ml-4');
            chatMessages.appendChild(loadingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            const prompt = `
                Du bist ein Experte für die "Verordnung des SBFI über die berufliche Grundbildung Polymechanikerin/Polymechaniker mit eidgenössischem Fähigkeitszeugnis (EFZ)". 
                Beantworte die folgende Frage eines Studenten ausschliesslich auf Basis des bereitgestellten Verordnungstextes.
                Erkläre die relevanten Artikel klar und verständlich und verwende **fettgedruckten Text** für Schlüsselbegriffe.
                Verweise auf die zitierten Artikel mit dem Format **(Art. X)** am Ende des Satzes, in dem der Artikel zitiert wird.
                
                Verordnungstext:
                
                """
                ${verordnungstext}
                """
                
                Frage: ${userText}
            `;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = {
                contents: chatHistory
            };

            let response;
            try {
                // Exponential backoff retry logic
                let retries = 0;
                const maxRetries = 5;
                let delay = 1000;

                while (retries < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.status !== 429) {
                            break;
                        }
                        retries++;
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } catch (error) {
                        retries++;
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    }
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text || 'Entschuldigung, ich konnte keine Antwort finden.';

                // Remove loading indicator
                chatMessages.removeChild(loadingIndicator);
                addMessage(botResponse, 'bot');
            } catch (error) {
                console.error('Fetch error:', error);
                // Remove loading indicator
                chatMessages.removeChild(loadingIndicator);
                addMessage('Es ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut.', 'bot');
            } finally {
                sendButton.disabled = false;
                userForm.disabled = false;
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        userForm.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });

    </script>
</body>
</html>
